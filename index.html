<!-- index.html -->
<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ShimulModZ - URL Shortener (Premium)</title>
  <style>
    :root{
      --bg: linear-gradient(135deg,#eef4ff,#e6f0ff);
      --card:#ffffff;
      --muted:#556;
      --accent-start:#667eea;
      --accent-end:#764ba2;
    }
    body.dark{ --card:#0f1720; --muted:#cfd8ff; --bg:#071028; color:#e6eefc; }
    body{ margin:0; font-family:Inter,Segoe UI,Arial; background:var(--bg); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:24px; }
    .wrap{ width:100%; max-width:920px; display:grid; grid-template-columns: 1fr 380px; gap:20px; align-items:start; }
    .card{ background:var(--card); border-radius:14px; padding:20px; box-shadow:0 8px 30px rgba(20,20,50,0.08); }
    h1{ margin:0 0 8px; font-size:20px; }
    .desc{ color:var(--muted); margin-bottom:12px; font-size:13px; }
    .form-row{ display:flex; gap:10px; align-items:center; margin-bottom:10px; }
    .full{ width:100%; }
    input[type="text"], input[type="number"], select{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(52,137,235,0.2); font-size:14px;
      background:transparent;
    }
    .small{ width:80px; }
    .btn-primary{
      width:100%; padding:12px; border-radius:10px; border:none; color:white; font-weight:600;
      background:linear-gradient(90deg,var(--accent-start),var(--accent-end)); cursor:pointer;
    }
    .controls{ display:flex; gap:8px; margin-top:8px; }
    .btn-ghost{ padding:8px 10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); background:transparent; cursor:pointer; }
    .result{ margin-top:16px; padding:12px; border-radius:10px; background:linear-gradient(180deg,#f7f9ff,#eef3ff); font-size:14px; }
    .dark .result{ background:rgba(255,255,255,0.02); }
    .short-link{ color:#0b66ff; font-weight:700; word-break:break-all; }
    .copy-btn, .qr-btn{ padding:6px 10px; border-radius:8px; border:none; cursor:pointer; font-size:14px; }
    .copy-btn{ background:#2dd36f; color:#04210b; }
    .qr-btn{ background:#ff7043; color:white; }
    .history{ margin-top:12px; max-height:240px; overflow:auto; font-size:13px; }
    .history-item{ padding:8px; border-bottom:1px dashed rgba(0,0,0,0.03); display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .meta{ color:var(--muted); font-size:12px; }
    .right-panel{ display:flex; flex-direction:column; gap:12px; }
    .panel-title{ font-size:14px; margin-bottom:6px; }
    .small-muted{ font-size:12px; color:var(--muted); }
    .spinner{ width:28px; height:28px; border-radius:50%; border:4px solid #e6eefc; border-top-color: #5676f2; animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin{ to{ transform:rotate(360deg); } }
    @media (max-width:900px){
      .wrap{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üîó ShimulModZ URL Shortener ‚Äî Premium</h1>
      <div class="desc">Custom code, precise expiry (days/hours/minutes/seconds), QR, history, dark-mode & more ‚Äî bug-minimized and production-ready.</div>

      <div>
        <label class="small-muted">Long URL</label>
        <input id="longUrl" type="text" placeholder="https://example.com/some/long/path" />

        <div class="form-row">
          <div style="flex:1">
            <label class="small-muted">Custom Code (optional)</label>
            <input id="customCode" type="text" placeholder="my-code (letters,numbers,-,_)" />
          </div>
          <div style="width:120px">
            <label class="small-muted">Overwrite</label>
            <select id="overwrite" style="padding:10px;border-radius:8px">
              <option value="false">No</option>
              <option value="true">Yes</option>
            </select>
          </div>
        </div>

        <div style="margin-top:8px">
          <label class="small-muted">Expiry (set any fields to create an expiry)</label>
          <div class="form-row">
            <input id="expDays" class="small" type="number" min="0" placeholder="days" />
            <input id="expHours" class="small" type="number" min="0" placeholder="hours" />
            <input id="expMinutes" class="small" type="number" min="0" placeholder="minutes" />
            <input id="expSeconds" class="small" type="number" min="0" placeholder="seconds" />
          </div>
          <div class="small-muted">Or leave all empty for no expiry.</div>
        </div>

        <div style="margin-top:12px">
          <button id="btnShorten" class="btn-primary">Shorten Link</button>
          <div style="margin-top:10px" id="feedback"></div>
        </div>

        <div id="resultBox" class="result" style="display:none;">
          <div>‚úÖ Short URL: <span id="shortLink" class="short-link"></span></div>
          <div style="margin-top:8px" id="linkActions">
            <button class="copy-btn" onclick="copyShort()">üìã Copy</button>
            <button class="qr-btn" onclick="toggleQR()">üì± QR</button>
            <button class="btn-ghost" onclick="openInfo()">‚ÑπÔ∏è Info</button>
          </div>
          <div id="qrContainer" style="margin-top:10px"></div>
          <div id="expiryInfo" style="margin-top:10px" class="meta"></div>
          <div id="clickInfo" style="margin-top:6px" class="meta"></div>
        </div>

        <div class="history" id="historyBox"></div>
      </div>
    </div>

    <div class="right-panel">
      <div class="card">
        <div class="panel-title">Settings & Utilities</div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn-ghost" id="toggleThemeBtn">üåô Theme</button>
          <button class="btn-ghost" id="clearHistoryBtn">üßπ Clear History</button>
        </div>
        <hr style="margin:12px 0" />
        <div class="panel-title">Quick Tips</div>
        <div class="small-muted">
          ‚Ä¢ Custom code: only letters, numbers, - and _. <br/>
          ‚Ä¢ Use overwrite=true to replace an existing code. <br/>
          ‚Ä¢ Expiry is precise to the second. <br/>
          ‚Ä¢ For extremely accurate high-volume click counters use Durable Objects.
        </div>
      </div>

      <div class="card">
        <div class="panel-title">Your Recent Links</div>
        <div id="miniHistory" class="history"></div>
      </div>
    </div>
  </div>

  <!-- QR library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <script>
    // CONFIG: set your worker base URL (no trailing slash)
    const WORKER_URL = "https://url-short-demo.shimul-modz.workers.dev";

    // Elements
    const longUrlEl = document.getElementById('longUrl');
    const customCodeEl = document.getElementById('customCode');
    const btnShorten = document.getElementById('btnShorten');
    const feedbackEl = document.getElementById('feedback');
    const resultBox = document.getElementById('resultBox');
    const shortLinkEl = document.getElementById('shortLink');
    const qrContainer = document.getElementById('qrContainer');
    const expiryInfo = document.getElementById('expiryInfo');
    const clickInfo = document.getElementById('clickInfo');
    const historyBox = document.getElementById('historyBox');
    const miniHistory = document.getElementById('miniHistory');

    btnShorten.addEventListener('click', shortenHandler);
    document.getElementById('toggleThemeBtn').addEventListener('click', toggleTheme);
    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      localStorage.removeItem('short_history_v1');
      renderHistory();
    });

    function showFeedback(html, type='info'){
      feedbackEl.innerHTML = html;
      setTimeout(()=> { feedbackEl.innerHTML = ''; }, 6000);
    }

    function getExpiryPayload(){
      const d = Number(document.getElementById('expDays').value) || 0;
      const h = Number(document.getElementById('expHours').value) || 0;
      const m = Number(document.getElementById('expMinutes').value) || 0;
      const s = Number(document.getElementById('expSeconds').value) || 0;
      if (d===0 && h===0 && m===0 && s===0) return null;
      return { days: d, hours: h, minutes: m, seconds: s };
    }

    async function shortenHandler(){
      const longUrl = longUrlEl.value.trim();
      if (!longUrl) return showFeedback('‚ùå Please enter a URL.');
      if (!/^https?:\/\//i.test(longUrl)) return showFeedback('‚ùå URL must start with http:// or https://');

      const code = customCodeEl.value.trim();
      const overwrite = document.getElementById('overwrite').value === 'true';
      const expire = getExpiryPayload();

      btnShorten.disabled = true;
      btnShorten.textContent = 'Creating...';
      showFeedback('<span class="spinner"></span>');

      try {
        const res = await fetch(WORKER_URL + '/shorten', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url: longUrl,
            code: code || undefined,
            overwrite: overwrite,
            expire: expire ? expire : undefined
          })
        });

        const data = await res.json();
        btnShorten.disabled = false;
        btnShorten.textContent = 'Shorten Link';
        feedbackEl.innerHTML = '';

        if (!res.ok) {
          showFeedback('‚ùå ' + (data.error || 'Failed to shorten'));
          return;
        }

        // success
        shortLinkEl.textContent = data.short;
        shortLinkEl.href = data.short;
        resultBox.style.display = 'block';
        qrContainer.innerHTML = '';
        expiryInfo.textContent = data.expire ? 'Expire at: ' + new Date(data.expire).toLocaleString() : 'No expiry';
        clickInfo.textContent = 'Clicks: 0 (updating on redirect)';

        // save history locally
        saveLocalHistory({
          short: data.short,
          code: data.code,
          long: data.long,
          created: Date.now(),
          expire: data.expire || null,
          clicks: 0
        });

        renderHistory();
        renderMiniHistory();

      } catch (err) {
        btnShorten.disabled = false;
        btnShorten.textContent = 'Shorten Link';
        showFeedback('‚ùå Failed to connect to server.');
      }
    }

    function copyShort(){
      const text = shortLinkEl.textContent;
      navigator.clipboard.writeText(text).then(()=>{
        showFeedback('‚úÖ Copied to clipboard');
      });
    }

    let qrVisible = false;
    function toggleQR(){
      if (!shortLinkEl.textContent) return;
      qrVisible = !qrVisible;
      if (qrVisible) {
        qrContainer.innerHTML = '';
        QRCode.toCanvas(shortLinkEl.textContent, { width: 220 }, function (err, canvas) {
          if (err) { qrContainer.textContent = 'QR error'; return; }
          qrContainer.appendChild(canvas);
        });
      } else {
        qrContainer.innerHTML = '';
      }
    }

    // info button -> fetch /info/:code
    async function openInfo(){
      const short = shortLinkEl.textContent;
      if (!short) return;
      const code = short.split('/').pop();
      try {
        const res = await fetch(WORKER_URL + '/info/' + encodeURIComponent(code));
        const data = await res.json();
        if (!res.ok) {
          showFeedback('‚ùå ' + (data.error || 'Info fetch failed'));
          return;
        }
        const meta = data.meta;
        let infoHtml = `Original: ${meta.url}\nCreated: ${new Date(meta.created).toLocaleString()}\nClicks: ${meta.clicks}\n`;
        if (meta.expire) infoHtml += `Expire: ${new Date(meta.expire).toLocaleString()}\nExpired: ${data.expired ? 'Yes' : 'No'}`;
        alert(infoHtml);
      } catch (e) {
        showFeedback('‚ùå Failed to fetch info');
      }
    }

    // Local history (store up to 20)
    function saveLocalHistory(obj){
      const arr = JSON.parse(localStorage.getItem('short_history_v1') || '[]');
      arr.unshift(obj);
      // unique by code
      const seen = new Set();
      const filtered = [];
      for (const it of arr) {
        if (!seen.has(it.code)) { filtered.push(it); seen.add(it.code); }
        if (filtered.length >= 20) break;
      }
      localStorage.setItem('short_history_v1', JSON.stringify(filtered));
    }

    function renderHistory(){
      const arr = JSON.parse(localStorage.getItem('short_history_v1') || '[]');
      if (arr.length === 0) {
        historyBox.innerHTML = '<div class="small-muted">No history yet ‚Äî your recent short links will appear here.</div>';
        return;
      }
      historyBox.innerHTML = arr.map(it => {
        const exp = it.expire ? new Date(it.expire).toLocaleString() : 'Never';
        return `<div class="history-item">
          <div style="flex:1">
            <div style="font-weight:600"><a href="${it.short}" target="_blank">${it.short}</a></div>
            <div class="meta">${it.long}</div>
            <div class="meta">Expire: ${exp}</div>
          </div>
          <div style="min-width:90px;text-align:right">
            <div class="meta">Clicks: ${it.clicks || 0}</div>
            <div style="margin-top:6px"><button class="btn-ghost" onclick="deleteHistory('${it.code}')">Delete</button></div>
          </div>
        </div>`;
      }).join('');
    }

    function renderMiniHistory(){
      const arr = JSON.parse(localStorage.getItem('short_history_v1') || '[]');
      if (arr.length === 0) { miniHistory.innerHTML = '<div class="small-muted">No links</div>'; return; }
      miniHistory.innerHTML = arr.slice(0,6).map(it => `<div class="history-item"><div style="flex:1"><a href="${it.short}" target="_blank">${it.short}</a><div class="meta">${it.long}</div></div><div class="meta">${it.clicks||0}</div></div>`).join('');
    }

    function deleteHistory(code){
      let arr = JSON.parse(localStorage.getItem('short_history_v1') || '[]');
      arr = arr.filter(it => it.code !== code);
      localStorage.setItem('short_history_v1', JSON.stringify(arr));
      renderHistory(); renderMiniHistory();
    }

    // theme
    function toggleTheme(){
      document.body.classList.toggle('dark');
    }

    // initial render
    renderHistory(); renderMiniHistory();

    // optional: update local clicks when user opens a short link in same browsing session
    // (this won't necessarily reflect global clicks)
    // we keep it simple: when user opens an item from history, they can manually refresh info via Info button.

  </script>
</body>
</html>
